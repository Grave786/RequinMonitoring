{% extends 'OrgDashboard.html' %}
{% block dashboard_content %}
<div class="row justify-content-center pt-4">
    <div class="col-12 col-md-8 col-lg-6 mb-4">
        <div class="card shadow rounded-4 border-0">
            <div class="card-body p-5">
                <h3 class="text-center mb-4">Assign Project to Employee</h3>
                {% if msg1 is not none and msg1 and msg2 is not none and msg2 %}
                <div class="d-flex justify-content-center mb-4">
                    <lottie-player 
                        src="https://assets5.lottiefiles.com/packages/lf20_slipwrv0.json"
                        background="transparent" 
                        speed="1"
                        style="width: 300px; height: 250px;" 
                        loop autoplay>
                    </lottie-player>
                </div>
                <form action="/assign-proj" method="POST">
                    {% csrf_token %}
                    <div class="mb-4">
                        <div class="form-group mb-3">
                            <label class="form-label" for="projectSelect">Choose Project:</label>
                            <select class="form-control" id="projectSelect" name="p_id">
                                <option value="0" selected>Select Project</option>
                                {% for test1 in msg1 %}
                                <option value="{{ test1.id }}">{{ test1.p_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label" for="employeeSelect">Choose Employee:</label>
                            <select class="form-control" id="employeeSelect" name="e_id" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Assign</button>
                    </div>
                </form>
                {% else %}
                <div class="text-center">
                    <lottie-player 
                        src="https://assets7.lottiefiles.com/datafiles/vhvOcuUkH41HdrL/data.json"
                        background="transparent" 
                        speed="1"
                        style="width: 300px; height: 300px;" 
                        loop autoplay>
                    </lottie-player>
                    <h3 class="h3 text-center">
                        For assigning employees to a project, you must have at least one project and one employee.
                    </h3>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    $('#projectSelect').change(function(){
        const pid = $('#projectSelect').val();
        console.log("Selected Project ID:", pid);

        // Clear employee dropdown first
        $('#employeeSelect').empty();
        $('#employeeSelect').append('<option value="">Loading...</option>');

        if (!pid || pid === "0") {
            $('#employeeSelect').html('<option value="">Select Employee</option>');
            return;
        }

        const request_url = '/get_emps_not_in_project/' + pid;

        $.ajax({
            url: request_url,
            type: 'GET',
            dataType: 'json',
            success: function(data){
                console.log("Response from server:", data);
                $('#employeeSelect').empty();

                // Handle errors or unexpected responses
                if (!Array.isArray(data)) {
                    $('#employeeSelect').append('<option value="">Error: Invalid data format</option>');
                    console.error("Expected array but got:", data);
                    return;
                }

                if (data.length === 0) {
                    $('#employeeSelect').append('<option value="">No unassigned employees available</option>');
                    return;
                }

                $('#employeeSelect').append('<option value="">Select Employee</option>');

                // âœ… Proper loop for list of objects
                data.forEach(function(emp){
                    if (emp.id && emp.name) {
                        $('#employeeSelect').append(
                            '<option value="' + emp.id + '">' + emp.name + '</option>'
                        );
                    }
                });
            },
            error: function(xhr, status, error){
                console.error("AJAX Error:", error);
                $('#employeeSelect').html('<option value="">Failed to load employees</option>');
            }
        });
    });
});
</script>
{% endblock %}
